#!/usr/bin/env bash
# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
##@Version           :  202207081016-git
# @Author            :  Jason Hempstead
# @Contact           :  jason@casjaysdev.com
# @License           :  WTFPL
# @ReadME            :  tmux-new --help
# @Copyright         :  Copyright: (c) 2022 Jason Hempstead, Casjays Developments
# @Created           :  Friday, Jul 08, 2022 10:16 EDT
# @File              :  tmux-new
# @Description       :
# @TODO              :
# @Other             :
# @Resource          :
# @sudo/root         :  no
# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
APPNAME="$(basename "$0" 2>/dev/null)"
VERSION="202207081016-git"
HOME="${USER_HOME:-$HOME}"
USER="${SUDO_USER:-$USER}"
RUN_USER="${SUDO_USER:-$USER}"
SRC_DIR="${BASH_SOURCE%/*}"
# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
# Set bash options
if [[ "$1" == "--debug" ]]; then shift 1 && set -xo pipefail && export SCRIPT_OPTS="--debug" && export _DEBUG="on"; fi

# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
# Import functions
CASJAYSDEVDIR="${CASJAYSDEVDIR:-/usr/local/share/CasjaysDev/scripts}"
SCRIPTSFUNCTDIR="${CASJAYSDEVDIR:-/usr/local/share/CasjaysDev/scripts}/functions"
SCRIPTSFUNCTFILE="${SCRIPTSAPPFUNCTFILE:-testing.bash}"
SCRIPTSFUNCTURL="${SCRIPTSAPPFUNCTURL:-https://github.com/dfmgr/installer/raw/main/functions}"
# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
if [ -f "$PWD/$SCRIPTSFUNCTFILE" ]; then
  . "$PWD/$SCRIPTSFUNCTFILE"
elif [ -f "$SCRIPTSFUNCTDIR/$SCRIPTSFUNCTFILE" ]; then
  . "$SCRIPTSFUNCTDIR/$SCRIPTSFUNCTFILE"
else
  echo "Can not load the functions file: $SCRIPTSFUNCTDIR/$SCRIPTSFUNCTFILE" 1>&2
  exit 1
fi
# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
# user system devenv dfmgr dockermgr fontmgr iconmgr pkmgr systemmgr thememgr wallpapermgr
system_install
__options "$@"
# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
# Set functions
__list_options() { printf_custom "$1" "$2: $(echo ${3:-$ARRAY} | __sed 's|:||g;s|'$4'| '$5'|g')" 2>/dev/null; }
# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
__gen_config() {
  [[ -z "$NOTIFY_CLIENT_NAME" ]] || NOTIFY_CLIENT_NAME=""
  [[ "$INIT_CONFIG" = "TRUE" ]] || printf_green "Generating the config file in"
  [[ "$INIT_CONFIG" = "TRUE" ]] || printf_green "$TMUX_NEW_CONFIG_DIR/$TMUX_NEW_CONFIG_FILE"
  [ -d "$TMUX_NEW_CONFIG_DIR" ] || mkdir -p "$TMUX_NEW_CONFIG_DIR"
  [ -d "$TMUX_NEW_CONFIG_BACKUP_DIR" ] || mkdir -p "$TMUX_NEW_CONFIG_BACKUP_DIR"
  [ -f "$TMUX_NEW_CONFIG_DIR/$TMUX_NEW_CONFIG_FILE" ] &&
    cp -Rf "$TMUX_NEW_CONFIG_DIR/$TMUX_NEW_CONFIG_FILE" "$TMUX_NEW_CONFIG_BACKUP_DIR/$TMUX_NEW_CONFIG_FILE.$$"
  cat <<EOF >"$TMUX_NEW_CONFIG_DIR/$TMUX_NEW_CONFIG_FILE"
# Settings for tmux-new
TMUX_NEW_TMUX_CONF="${TMUX_NEW_TMUX_CONF:-$TMUX_NEW_CONFIG_DIR}"

# Notification settings
TMUX_NEW_GOOD_MESSAGE="${TMUX_NEW_GOOD_MESSAGE:-Everything Went OK}"
TMUX_NEW_ERROR_MESSAGE="${TMUX_NEW_ERROR_MESSAGE:-Well something seems to have gone wrong}"
TMUX_NEW_NOTIFY_ENABLED="${TMUX_NEW_NOTIFY_ENABLED:-yes}"
TMUX_NEW_NOTIFY_CLIENT_NAME="${NOTIFY_CLIENT_NAME:-$APPNAME}"
TMUX_NEW_NOTIFY_CLIENT_ICON="${NOTIFY_CLIENT_ICON:-$TMUX_NEW_NOTIFY_CLIENT_ICON}"

# Colorization settings
TMUX_NEW_OUTPUT_COLOR="${TMUX_NEW_OUTPUT_COLOR:-5}"
TMUX_NEW_OUTPUT_COLOR_GOOD="${TMUX_NEW_OUTPUT_COLOR_GOOD:-2}"
TMUX_NEW_OUTPUT_COLOR_ERROR="${TMUX_NEW_OUTPUT_COLOR_ERROR:-1}"

EOF
  if [ -f "$TMUX_NEW_CONFIG_DIR/$TMUX_NEW_CONFIG_FILE" ]; then
    [[ "$INIT_CONFIG" = "TRUE" ]] || printf_green "Your config file for $APPNAME has been created"
    exitCode=0
  else
    printf_red "Failed to create the config file"
    exitCode=1
  fi
  return ${exitCode:-$?}
}
# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
# Additional functions
__launch_tmux() {
  # Set variables
  local session="${1:-default}"
  local name="$session"
  # Create config files
  if [[ ! -f "$TMUX_NEW_CONFIG_DIR/$name.local" ]] && [[ ! -f "$TMUX_NEW_TMUX_CONF/$name.conf" ]]; then
    printf_green "Creating tmux config file"
    __tmux_conf "$name"
    cat <<EOF >"$TMUX_NEW_CONFIG_DIR/$name.local"
# start with 2 windows
neww -n buildx bash
neww -n tailf  bash

EOF
  fi
  # Start tmux
  sleep 3
  tmux -f "$TMUX_NEW_TMUX_CONF/$name.conf" new-session -D -A -s $name 'tmux source-file '$TMUX_NEW_TMUX_CONF/$name.local''
  return $?
}
__tmux_conf() {
  local name="$1"
  printf_cyan "Creating $TMUX_NEW_TMUX_CONF/$name.conf"
  if [[ -f "$CASJAYSDEVDIR/templates/tmux-new.conf" ]] && [[ ! -f "$TMUX_NEW_TMUX_CONF/$name.conf" ]]; then
    cp -Rf "$CASJAYSDEVDIR/templates/tmux-new.conf" "$TMUX_NEW_TMUX_CONF/$name.conf"
    sed -i 's|TMUX_NEW_TMUX_CONF|'$TMUX_NEW_TMUX_CONF/$name'|g' "$TMUX_NEW_TMUX_CONF/$name.conf"
  fi
  [[ -f "$TMUX_NEW_TMUX_CONF/$name.conf" ]] || printf_red "Failed to create the config file"
}
# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
# Default variables
exitCode=
# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
# Application Folders
TMUX_NEW_LOG_DIR="${TMUX_NEW_LOG_DIR:-$HOME/.local/log/tmux-new}"
TMUX_NEW_CACHE_DIR="${TMUX_NEW_CACHE_DIR:-$HOME/.cache/tmux-new}"
TMUX_NEW_CONFIG_DIR="${TMUX_NEW_CONFIG_DIR:-$HOME/.config/misc/settings/tmux-new}"
TMUX_NEW_OPTIONS_DIR="${TMUX_NEW_OPTIONS_DIR:-$HOME/.local/share/misc/settings/tmux-new/options}"
TMUX_NEW_CONFIG_BACKUP_DIR="${TMUX_NEW_CONFIG_BACKUP_DIR:-$HOME/.local/share/misc/settings/tmux-new/backups}"
TMUX_NEW_TEMP_DIR="${TMUX_NEW_TEMP_DIR:-$HOME/.local/tmp/misc/tmux-new}"
TMUX_NEW_CONFIG_FILE="${TMUX_NEW_CONFIG_FILE:-settings.conf}"
TMUX_NEW_GOOD_MESSAGE="${TMUX_NEW_GOOD_MESSAGE:-Everything Went OK}"
TMUX_NEW_ERROR_MESSAGE="${TMUX_NEW_ERROR_MESSAGE:-Well something seems to have gone wrong}"
TMUX_NEW_NOTIFY_ENABLED="${TMUX_NEW_NOTIFY_ENABLED:-yes}"
TMUX_NEW_NOTIFY_CLIENT_NAME="${NOTIFY_CLIENT_NAME:-$APPNAME}"
TMUX_NEW_NOTIFY_CLIENT_ICON="${NOTIFY_CLIENT_ICON:-$TMUX_NEW_NOTIFY_CLIENT_ICON}"
TMUX_NEW_OUTPUT_COLOR="${TMUX_NEW_OUTPUT_COLOR:-5}"
TMUX_NEW_OUTPUT_COLOR_GOOD="${TMUX_NEW_OUTPUT_COLOR_GOOD:-2}"
TMUX_NEW_OUTPUT_COLOR_ERROR="${TMUX_NEW_OUTPUT_COLOR_ERROR:-1}"
# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
# Enviroment overrides
TMUX_NEW_TMUX_CONF="${TMUX_NEW_TMUX_CONF:-$TMUX_NEW_CONFIG_DIR}"

# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
# Generate config files
[ -f "$TMUX_NEW_CONFIG_DIR/$TMUX_NEW_CONFIG_FILE" ] || [[ "$*" = *config ]] || INIT_CONFIG="${INIT_CONFIG:-TRUE}" __gen_config ${SETARGS:-$@}
# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
# Import config
[ -f "$TMUX_NEW_CONFIG_DIR/$TMUX_NEW_CONFIG_FILE" ] && . "$TMUX_NEW_CONFIG_DIR/$TMUX_NEW_CONFIG_FILE"
# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
# Ensure Directories and files exist
[ -d "$TMUX_NEW_LOG_DIR" ] || mkdir -p "$TMUX_NEW_LOG_DIR" &>/dev/null
[ -d "$TMUX_NEW_TEMP_DIR" ] || mkdir -p "$TMUX_NEW_TEMP_DIR" &>/dev/null
[ -d "$TMUX_NEW_CACHE_DIR" ] || mkdir -p "$TMUX_NEW_CACHE_DIR" &>/dev/null
TMUX_NEW_TEMP_FILE="${TMUX_NEW_TEMP_FILE:-$(mktemp $TMUX_NEW_TEMP_DIR/XXXXXX 2>/dev/null)}"
# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
# Setup trap to remove temp file
trap 'exitCode=${exitCode:-$?};[ -n "$TMUX_NEW_TEMP_FILE" ] && [ -f "$TMUX_NEW_TEMP_FILE" ] && rm -Rf "$TMUX_NEW_TEMP_FILE" &>/dev/null' EXIT
# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
# Setup notification function
if [ "$TMUX_NEW_NOTIFY_ENABLED" = "yes" ]; then
  __notifications() {
    export NOTIFY_GOOD_MESSAGE="${TMUX_NEW_GOOD_MESSAGE}"
    export NOTIFY_ERROR_MESSAGE="${TMUX_NEW_ERROR_MESSAGE}"
    export NOTIFY_CLIENT_NAME="${TMUX_NEW_NOTIFY_CLIENT_NAME}"
    export NOTIFY_CLIENT_ICON="${TMUX_NEW_NOTIFY_CLIENT_ICON}"
    notifications "$@" && exitCode=0 || exitCode=1
    unset NOTIFY_CLIENT_NAME NOTIFY_CLIENT_ICON NOTIFY_GOOD_MESSAGE NOTIFY_ERROR_MESSAGE
    return ${exitCode:-$?}
  }
else
  __notifications() { false; }
fi
# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
# Show warn message if variables are missing

# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
# Set additional variables/Argument/Option settings
SETARGS="$*"
SHORTOPTS=""
LONGOPTS="debug,options,config,version,help,dir:"
ARRAY="build"
# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
# Setup application options
setopts=$(getopt -o "$SHORTOPTS" --long "$LONGOPTS" -a -n "$(basename "$0" 2>/dev/null)" -- "$@" 2>/dev/null)
eval set -- "${setopts[@]}" 2>/dev/null
while :; do
  case $1 in
  --debug)
    shift 1
    set -xo pipefail
    export SCRIPT_OPTS="--debug"
    export _DEBUG="on"
    ;;
  --options)
    shift 1
    [ -n "$1" ] || printf_blue "Current options for ${PROG:-$APPNAME}"
    [ -z "$SHORTOPTS" ] || __list_options "5" "Short Options" "-$SHORTOPTS" ',' '-'
    [ -z "$LONGOPTS" ] || __list_options "5" "Long Options" "--$LONGOPTS" ',' '--'
    [ -z "$ARRAY" ] || __list_options "5" "Base Options" "$ARRAY" ',' ''
    exit $?
    ;;
  --version)
    shift 1
    __version
    exit $?
    ;;
  --help)
    shift 1
    __help
    exit $?
    ;;
  --config)
    shift 1
    __gen_config
    exit $?
    ;;
  --dir)
    TMUX_NEW_CWD="$2"
    shift 2
    ;;
  --)
    shift 1
    break
    ;;
  esac
done
#set -- "$SETARGS"
# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
# Check for required applications/Network check
cmd_exists --error --ask bash tmux || exit 1 # exit 1 if not found
#__am_i_online --error || exit 1     # exit 1 if no internet
# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
# APP Variables overrides

# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
# Actions based on env

# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
# begin main app
case "$1" in
build)
  shift 1
  __launch_tmux build "$@"
  exitCode=$?
  ;;
*)
  [[ $# -eq 0 ]] && printf_exit "Usage: $APPNAME [options] [$ARRAY]"
  ;;
esac
# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
# End application
# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
# lets exit with code
exit ${exitCode:-$?}
# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
# end
